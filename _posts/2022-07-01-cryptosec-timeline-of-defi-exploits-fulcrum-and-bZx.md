---
title:  "The Timeline of DeFi Exploits: Fulcrum and bZx"
excerpt: "2020년 1월 11일, 2020년 2월 15일에 발생했던 Fulcrum, bZx DeFi 해킹사건에 대한 조사 결과입니다."
author: Panda
categories:
  - Security
  - Smart Contract
  - Incident
tags:
  - ITW
  - Review
  - Korean
#last_modified_at: 2021-09-23 18:06:00 +09:00
date: 2022-07-05 7:00:00 +09:00
lastmod: 2022-7-05 20:00:00 +09:00
sitemap :
changefreq : daily
priority : 1.0

# table of contents
toc: true # 오른쪽 부분에 목차를 자동 생성해준다.
toc_label: "table of content" # toc 이름 설정
toc_icon: "bars" # 아이콘 설정
toc_sticky: true # 마우스 스크롤과 함께 내려갈 것인지 설정
use_math: true #수식
#{% figure caption:"Le logo de **Jekyll** et son clin d'oeil à Robert Louis Stevenson"
#  %}
#  ![Le logo de Jekyll]({{"/assets/images_posts/2021-09-23-cve-2021-31956-part1/1.png"| #relative_url}})
#{% endfigure %}
---
# Introudction

# Fulcrum had a $2.5m vulnerability over a month ago and still hasn’t told anyone

# Arbs Exploit DeFi to Make $900k in Seconds; Provoke Soul-Searching in the Process
* bZx와 Fulcrum은 동일한 의미로 사용됨
* 단 하나의 트렌젝션에 의해 2020년 2월 15일 2.5M 달러정도 해킹당함

## Attack Scenario
공격 시나리오는 다음과 같습니다.

* 해커가 10k ETH를 flashloan으로 [dydx](https://dydx.exchange/) 거래소에서 빌림
* 해커가 5.5k ETH를 112 WBTC(Wrapped Bitcoin)으로 Compound DeFi에서 교환함
* bZx의 마진 거래 기능을 활용해서, BTC를 가지고 ETH를 숏을 치면서(매도하여 가격을 떨어뜨림), 1.3k ETH를 활용해 bZx에서 5배 숏포지션을 잡음
* 해커의 요청(5배 숏포지션)을 처리할려고, bZx는 5.6k ETH를 Kyberswap에서 51 WBTC로 교환 시도, Kyberswap는 이 요청을 처리하기 위해 Uniswap에 주문하고 이로 인해 Uniswap에서 WBTC 가격이 갑자기 상승함
* 스와핑 서브시에서 최대한 좋은 교환비로 ETH와 BTC를 교환을 시도했지만, 원래 51 BTC의 적절한 가치는 2k ETH이며, BTC와 ETH 모두 총 공급량이 타토큰 대비 상대적으로 상당히 제안되게 공급이 이뤄지기 때문에 가격이 급상승하게 되었고, 51BTC에 대해 5.6k를 bZx가 지불하게 됨
* bZx에서는 마진거래를 마감할 때가 되면 ETH 가격이 오르면, 해커의 예치금을 공제해 손실을 만회함. 하지만 해커의 예치금을 손실을 만회할 정도로 충분하지 않음(2k --> 5.6k, 약 3배 올랐음)
* 현재 bZx의 실질적은 손실은 2.3k ETH 정도 됨 만약에 해커가 마진 거래를 살리지 않는다면...
* Uniswap의 경우 스와핑 알고리즘이 CPMM임으로 현재 ETH의 가치가 BTC대비 떨어져 있음, 해커는 112 BTC를 Uniswap 풀에서 교환함, 약 6.8k ETH를 얻음, 이제는 BTC대비 ETH의 가치가 올라갔음
* 담보로 잡힌 5.5k ETH를 해제하기 위해서 112 WBTC의 가치에 해당하는 4.2k ETH를 컴파운드에 상환함
* 해커는 이제 12.5k ETH를 자산을 가지고 있고, 바로 10.0k ETH를 bZx에 상환하고, 쿨하게 1.3k ETH를 포기하고, 1.2k ETH의 이익을 취한다. bZx는 2.3k ETH의 영구적 손실을 입음

| ![Image Alt 텍스트]({{"/assets/images_post/2022-07-01-cryptosec-timeline-of-defi-exploits-fulcrum-and-bZx/bZx_attack_ani.gif"| relative_url}})  |
| 그림.1 bZx대상 Flashloan기반 공격 시나리오 애니메이션 |

다양한 자료에 공격에 대한 그림이 존재하지만, 해커를 중심에두고 순차적으로 공격을 그림으로 표현했기 때문에, 아마 공격에 대한 이해가 가장 쉬울 것으로 판단된다.

## Discussion

앞에서 공격에 대한 그림을 봤지만, Flashloan의 기능을 기반으로 하는 공격이며, 그렇지만 중요한 것은 왜 bZx인지를 알아내는 것이 블록체인 보안을 학습하는 입장에서는 중요하다. 과거 윈도우, 리눅스 보안에서의 표현을 빌리면 왜 수만은 Attack Surface중에 bZx라는 공격 벡터를 선택했느냐? 이것에 대해서 의견을 나눠볼 필요가 있고 이 것에 대한 토론 결과를 가지고 소스코드 분석을 통해 최대한 검증할 수 있는 것은 검증하는 것이 중요하다고 생각된다.

* 왜 ETH/BTC 일까?
  * BTC, ETH 이 두 토큰은 매우 시장에서 희소성을 가지고 있음, 타 토큰 대비 발행량이 매우 적음(추정)
* 해커는 공격 목표 DeFi를 어떤 기준으로 선택했을까?(왜 bZx인가?)
  * Flashloan 기능을 지원해야 한다.(Mandatory !!!)
  * Uniswap과 같은 CPMM기반의 Swapping 서비스를 활용해야 한다.
* Compound에서 돈을 빌린 이유는?

## Mitigation
bZx가 유사한 공격으로부터 자신들을 지키기위해 어떻게 패치했는지 그 내용을 분석해서, 이 섹션에 기술(TBA)

# Conclusion
* 우리는 Flashload 기능을 활용한 bZx을 대상으로 한 공격을 살펴봤음. 이 공격의 핵심은 Flashloan 기능에도 있지만, 또한 Uniswap과 같은 CPMM 알고리즘을 기반으로 토큰간의 가치를 결정하는 변동성에도 있는 것으로 판단됨

# References
* [https://cryptosec.info/defi-hacks/](https://cryptosec.info/defi-hacks/)
* [https://blog.1inch.io/yes-we-hacked-bzx-fulcrum-but-one-month-ago-3f7e5c437ee3](https://blog.1inch.io/yes-we-hacked-bzx-fulcrum-but-one-month-ago-3f7e5c437ee3)
* [https://newsletter.thedefiant.io/p/arbs-exploit-defi-to-make-900k-in](https://newsletter.thedefiant.io/p/arbs-exploit-defi-to-make-900k-in) 
* [https://www.coinbase.com/learn/market-updates/around-the-block-issue-3](https://www.coinbase.com/learn/market-updates/around-the-block-issue-3)
* [https://mudit.blog/bzx-hack-analysis-defi-legos/](https://mudit.blog/bzx-hack-analysis-defi-legos/)
